# K9s: Otro estilo de CLI para k8s
K9s es una interfaz de usuario basada en un terminal para interactuar con sus cl√∫steres Kubernetes. El objetivo de este proyecto es facilitar la navegaci√≥n, la observaci√≥n y la gesti√≥n de sus aplicaciones desplegadas en la naturaleza. K9s observa continuamente a Kubernetes en busca de cambios y ofrece comandos posteriores para interactuar con sus recursos observados.

Preview de la web oficial:

[![asciicast](https://asciinema.org/a/305944.svg)](https://asciinema.org/a/305944)

**√çndice**
- [K9s: Otro estilo de CLI para k8s](#k9s-otro-estilo-de-cli-para-k8s)
  - [Instalar k9s con el c√≥digo](#instalar-k9s-con-el-c√≥digo)
  - [Argumentos CLI](#argumentos-cli)
  - [Key Bindings](#key-bindings)
  - [Usando k9s](#usando-k9s)
    - [Visualizaci√≥n de recursos](#visualizaci√≥n-de-recursos)
    - [Buscar](#buscar)
    - [Navegando por los recursos de Kubernetes](#navegando-por-los-recursos-de-kubernetes)
    - [Logs de los recursos de Kubernetes](#logs-de-los-recursos-de-kubernetes)
    - [Operaciones en recursos Kubernetes](#operaciones-en-recursos-kubernetes)
    - [Herramientas de monitorizaci√≥n](#herramientas-de-monitorizaci√≥n)
    - [Aliases](#aliases)
    - [Popeye scanning](#popeye-scanning)

## Instalar k9s con el c√≥digo

Para estar seguro de como se instala lo mejor es mirar la [documentaci√≥n oficial](https://k9scli.io/topics/install/) o el [repositorio git](https://github.com/derailed/k9s), teniendo en cuenta que actualizan m√°s el repo. Yo lo he instalado as√≠:

```shell
# Primero instalar golang si no lo tienes ya
sudo apt install golang
## Se comprueba la versi√≥n
go version
```
```shell
# descargamos con git y entramos en la carpeta
git clone https://github.com/derailed/k9s.git && cd k9s
```
```shell
# Se ejecuta el Makefile
make build && ./execs/k9s
```
```shell
# Se mueve el contenido en carpeta oculta
mv k9s .k9s
```
```shell
# Se copia el binario a bin local
sudo cp .k9s/execs/k9s /usr/local/bin/.
```
```shell
#Se comprueba si podemos entrar al cluster de nuestro contexto
k9s
```
No es muy ortodoxo pero es funcional. 

## Argumentos CLI

K9s CLI viene con una vista de argumentos que puede utilizar para lanzar la herramienta con diferente configuraci√≥n.
```shell
# Lista de todas las opciones de la CLI disponibles
k9s help
```
```shell
# Obtener informaci√≥n sobre el tiempo de ejecuci√≥n de K9s (registros, configuraciones, etc.)
k9s info
```
```shell
# Ejecutar K9s en un espacio de nombres determinado.
k9s -n mycoolns
```
```shell
# Ejecutar K9s y lanzarlo en la vista de pod a trav√©s del comando pod.
k9s -c pod
```
```shell
# Inicie K9s en un contexto KubeConfig no predeterminado
k9s --context coolCtx
```
```shell
# Inicie K9s en modo de s√≥lo lectura - con todos los comandos de modificaci√≥n deshabilitados
k9s --readonly
```
Por defecto k9s leer√° el KUBECONFIG actual, que a su vez se lee por defecto de $HOME/.kube/config. En todo caso se le puede indicar

```shell
# Exportar archivo de configuraci√≥n de kubectl
 k9s --kubeconfig .kube/config
```

## Key Bindings

Acci√≥n | Comando | Comentario
---|---|---
Mostrar los mnem√≥nicos de teclado activos y la ayuda | `?` 	 
Mostrar todos los alias y recursos disponibles en el cl√∫ster | `ctrl-a` o `:alias` 	 
Salir de K9s | `:q`, `ctrl-c` 	 
Ver un recurso de Kubernetes utilizando el singular/plural o el nombre corto | `:po`‚èé | acepta el singular, el plural, el nombre corto o el alias, es decir, pod o pods
Ver un recurso de Kubernetes en un espacio de nombres dado | `:alias namespace`‚èé 	 
Filtrar una vista de recursos dado un filtro | `/filter`‚èé | Regex2 soportado ie `fred\|blee` para filtrar recursos llamados fred o blee
Filtro regex inverso | `/ ! filter`‚èé | Guarda todo lo que no coincide. No se ha implementado para los registros.
Filtrar la vista de recursos por etiquetas | `/-l label-selector`‚èé 	 
Buscar difusamente un recurso dado un filtro | `/-f filter`‚èé 	 
Sale del modo de vista/comando/filtro | `<esc>` 	 
Mapeo de teclas para describir, ver, editar, ver registros,... | `d`,`v`, `e`, `l`,... 	 
Para ver y cambiar a otro contexto de Kubernetes | `:ctx`‚èé 	 
Para ver y cambiar a otro contexto de Kubernetes | `:ctx context-name`‚èé 	 
Para ver y cambiar a otro espacio de nombres de Kubernetes | `:ns`‚èé 	 
Para ver todos los recursos guardados | `:screendump o sd`‚èé 	 
Para eliminar un recurso (TAB y ENTER para confirmar) | `ctrl-d` 	 
Para eliminar un recurso (¬°no hay di√°logo de confirmaci√≥n!) | `ctrl-k` 	 
Alternar columnas anchas | `ctrl-w` | Equivalente a kubectl ... -o wide
Alternar el estado de error | `ctrl-z` | Ver los recursos en estado de error
Lanzar la vista de pulsos | `:pulsos o pu`‚èé 	 
Lanzar vista XRay | `:xray RECURSO [NAMESPACE]`‚èé | RECURSO puede ser uno de po, svc, dp, rs, sts, ds, NAMESPACE es opcional
Lanzar la vista de Popeye | `:popeye o pop`‚èé | Ver https://popeyecli.io

## Usando k9s

Ya con `k9s` iniciado tendremos una pantalla de visualizaci√≥n en la que podremos darle [ordenes](#key-bindings). Por ejemplo, y como se indica en la anterior tabla, `?` es para pedir ayuda.

### Visualizaci√≥n de recursos

Si est√°s familiarizado con los [comandos de vim](https://gitea.vergaracarmona.es/man-linux/Guia-VIM), te sentir√°s como en casa con K9s. La forma de cambiar de introducir las ordenes es con dos puntos. As√≠, para ver los pods del cluster se debe escribir `:pods` y pulsar enter. Para ver los nodos se escribe `:node` e Intro. Se pueden ver sugerencias en la l√≠nea de comandos a medida que escribes, por lo que se puede aprovechar la opci√≥n de completar con el tabulador y ahorrar en pulsaciones. As√≠, para ver todos los espacios de nombres del cl√∫ster, s√≥lo tendr√° que escribir:

```shell
:na <tab> <enter
```

### Buscar

Si tienes muchos recursos de un tipo particular en un cluster, puedes buscar r√°pidamente a trav√©s de ellos usando el comando /. Si, por ejemplo, quieres filtrar todos los espacios de nombres que has recuperado en la secci√≥n anterior hasta llegar a los que contienen "kube" en su nombre, escribir√≠as

```shell
/kube
```

### Navegando por los recursos de Kubernetes

Podr√°s moverte por los recursos usando `j` para bajar y `k` para subir. ¬øTe suena? Tambi√©n es como vim. Para aquellos que nunca han aprendido a navegar con vim, las teclas de flecha funcionan igual de bien.

Puedes seleccionar el recurso que quieras y pulsar `d` para describirlo. 

### Logs de los recursos de Kubernetes

Puedes ver los logs de cualquier pod, job u otro recurso de Kubernetes utilizando el comando `l` con el recurso seleccionado. Sin embargo, ¬øqu√© pasa con la visualizaci√≥n de eventos pasados, si un recurso ha sido reemplazado por una nueva instancia de s√≠ mismo que ahora est√° escribiendo sus propios logs? K9s permite ver logs anteriores para ese recurso con el comando `p`, que es incre√≠blemente √∫til para rastrear errores u otros problemas.

Si est√°s viendo los registros y quieres ver exactamente cu√°ndo ocurri√≥ un evento, puedes usar `t` para insertar autom√°ticamente marcas de tiempo.

### Operaciones en recursos Kubernetes

Con K9s puedes **editar configuraciones** sobre la marcha. Pulsando `e` en cualquier recurso, se presentar√° el editor por defecto (probablemente vim si no has especificado otro) para editar el yaml de configuraci√≥n de ese pod, despliegue u recurso en concreto.

Obviamente, editando estas configuraciones afectar√° al cl√∫ster inmediatamente pero si se utiliza CI/CD podr√° ser sobrescritas por posteriores despliegues.

Tambi√©n se puede realizar **operaciones a nivel de nodo** con K9. Por ejemplo, se puede acordonar un nodo, o incluso vaciarlo para poder eliminarlo del pool o realizar otro tipo de mantenimiento en √©l.

Si existe alg√∫n pod que se est√° comportando mal, tambi√©n **se puede eliminar**. En la vista `:pods`, se selecciona y se pulsa `CTRL +d`. Pide confirmaci√≥n de la eliminaci√≥n.

Otra cosa que se pueda haces es **configurar port-forwarding** desde un pod espec√≠fico utilizando `SHIFT+f` y eligiendo el puerto local. Por ejemplo, si se elige el 3000 se podr√° ver el recurso en `localhost:3000`.

Aun hay m√°s, se puede **abrir un int√©rprete de comandos** en un pod que se esta ejecutando, claro, si lo soporta. Se selecciona el pod y se pulsa `s`. Esto es el equivalente a ejecutar `kubectl exec --stdin --tty <nombredelpod> -- /bin/bash`. Para salir es igual, con `exit`.

### Herramientas de monitorizaci√≥n

K9s dispone de un conjunto de herramientas de monitorizaci√≥n, adem√°s del polling peri√≥dico del recurso seleccionado (pod, nodo, etc) que se obtiene en la pantalla principal. Una de las visualizaciones m√°s interesantes es el modo `:pulses`. Con esta vista aparecen gr√°ficos live-updating y codificados por colores de los principales aspectos del cl√∫ster.

![pulses](https://k9scli.io/assets/screens/pulses.png)

Permite navegar para profundizar en cada pulso mostrado utilizando el tabulador o seleccionando el n√∫mero correspondiente al recurso concreto en la barra superior.

Para salir de cualquier vista es pulsando `Esc`.

### Aliases

Al igual que con la shell se pueden crear alias en K9s para acelerar los comandos comunes que se ejecuten. Para crear un alias, necesitas crear un archivo en el directorio `.k9s/`. Por defecto, √©ste se encuentra en la HOME de usuario: `$HOME/.k9s`. Es necesario crear un archivo llamado `alias.yml` en este directorio.

El formato de las definiciones de alias es en forma de `alias:grupo/versi√≥n/recurso`. Por ejemplo, si quieres hacer un alias `dep` para ver todos los despliegues, tendr√≠as que definirlo en `alias.yml` como

```yaml
alias:
  dep: apps/v1/deployments
```

Ahora en k9s se podr√° escribir `:dep <enter>` y ver sus despliegues.

En la [documentaci√≥n oficial](https://k9scli.io/topics/aliases/) hay m√°s detalles sobre la estructura y el uso del archivo de alias.

### Popeye scanning

K9s incluye la herramienta de desinfecci√≥n de Kubernetes Popeye. Permite comparar la configuraci√≥n de un cl√∫ster con las mejores pr√°cticas. Se abre con el comando `:popeye`. Esto abrir√° una p√°gina de resumen de escaneo que dar√° una puntuaci√≥n general y los componentes que Popeye ha analizado. Puede desglosar cualquier componente, como los conjuntos de demonios, para ver las razones de los resultados.

Para mitigar alguno de los problemas de configuraci√≥n detectados por el an√°lisis de Popeye se puede buscar el mensaje de error concreto.

<br><br>

Si aun tienes dudas puedes ver los [V√≠deo-tutoriales](https://k9scli.io/topics/video/) de [Fernand Galiana](https://github.com/derailed).

<br>

---

Por ahora est√° es la √∫ltima gu√≠a. Con el tiempo ir√© a√±adiendo m√°s, pero si tienes alguna petici√≥n ponte en contacto conmigo [aqu√≠](https://vergaracarmona.es) üòä

Todas las gu√≠as:

- [01 Instalaci√≥n kubctl](01-kubectl.md) 
- [02 Cl√∫sters](02-clusters.md) 
- [03 manifiestos](03-manifiestos.md) 
- [04 Cheatsheet kubernetes](04-cheatsheet.md) 
- [05 Helm: Control de despliegues en Kubernetes](05-helm.md) 
- [06 K9s: Otro estilo de CLI para k8s](06-k9s.md)
- 